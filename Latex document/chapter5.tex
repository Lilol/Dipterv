%----------------------------------------------------------------------------
\chapter{Experimental results}\label{chap:Tests}
%----------------------------------------------------------------------------
In the following chapter the results of the system tests will be discussed. 
Performance and precision criteria 
%----------------------------------------------------------------------------
\section{Evaluation results}
%----------------------------------------------------------------------------
\subsection{Test videos}

\begin{table}[]
		%\centering
	\begin{adjustbox}{center}
\begin{tabular}{|l|l|l|l|l|}
	\hline
	\multicolumn{1}{|c|}{\textbf{Video code}} & \multicolumn{1}{c|}{\textbf{Characteristics}}                                                     & \multicolumn{1}{c|}{\textbf{Lanes set}} & \multicolumn{1}{c|}{\textbf{\begin{tabular}[c]{@{}c@{}}Number of\\ GT\\  points\end{tabular}}} & \multicolumn{1}{c|}{\textbf{Special features}}                                                \\ \hline \hline
	\textbf{BorA1}                            & night, pedestrians                                                                                & no                                      & 14                                                                                             & minSize = 20                                                                                  \\ \hline
	\textbf{BorA2}                            & \begin{tabular}[c]{@{}l@{}}daytime, pedestrians, \\ stopping tram\end{tabular}                    & no                                      & 13                                                                                             & minSize = 10                                                                                  \\ \hline
	\textbf{ErA1}                             & night, low traffic                                                                                & yes                                     & 8                                                                                              & --                                                                                            \\ \hline
	\textbf{ErA2}                             & daytime, low traffic                                                                              & yes                                     & 59                                                                                             & --                                                                                            \\ \hline
	\textbf{ErC1}                             & \begin{tabular}[c]{@{}l@{}}daytime, stopping tram, \\ pedestrians\end{tabular}                    & yes                                     & 45                                                                                             & minSize = 40                                                                                  \\ \hline
	\textbf{ErE5}                             & \begin{tabular}[c]{@{}l@{}}recorded at the \\ IBikeBudapest cyclist \\ demonstration\end{tabular} & no                                      & 202                                                                                            & minSize = 10                                                                                  \\ \hline
	\textbf{ErzsC\_N}                         & \begin{tabular}[c]{@{}l@{}}night, low traffic, \\ some pedestrians\end{tabular}                   & yes                                     & 18                                                                                             & --                                                                                            \\ \hline
	\textbf{ErzsC\_S}                         & \begin{tabular}[c]{@{}l@{}}daytime, many\\ pedestrians, occlusion\end{tabular}                    & no                                      & 18                                                                                             & \begin{tabular}[c]{@{}l@{}}MOG2 overreaction \\ detection: higher \\ sensitivity\end{tabular} \\ \hline
	\textbf{ErzsD}                            & daytime, low traffic                                                                              & yes                                     & 32                                                                                             & --                                                                                            \\ \hline
	\textbf{FovamC\_D}                        & sundown, low traffic                                                                              & yes                                     & 79                                                                                             & --                                                                                            \\ \hline
	\textbf{FovamC\_N}                        & \begin{tabular}[c]{@{}l@{}}night, low traffic, \\ stopping vehicles\end{tabular}                  & no                                      & 38                                                                                             & --                                                                                            \\ \hline
	\textbf{FovC1}                            & sundown, low traffic                                                                              & yes                                     & 95                                                                                             & --                                                                                            \\ \hline
	\textbf{GoldA1}                           & night, medium traffic                                                                             & yes                                     & 13                                                                                             & --                                                                                            \\ \hline
	\textbf{GoldA2}                           & \begin{tabular}[c]{@{}l@{}}daytime, heavy traffic, \\ stopping vehicles\end{tabular}              & yes                                     & 68                                                                                             & calibration corrected                                                                         \\ \hline
	\textbf{GoldB1}                           & \begin{tabular}[c]{@{}l@{}}daytime, heavy traffic, \\ stopping vehicles\end{tabular}              & no                                      & 46                                                                                             & calibration corrected                                                                         \\ \hline
	\textbf{GoldB2}                           & daytime, low traffic                                                                              & yes                                     & 10                                                                                             & --                                                                                            \\ \hline
	\textbf{SasA1}                            & daytime, medium traffic                                                                           & yes                                     & 194                                                                                            & --                                                                                            \\ \hline
	\textbf{SasadA1}                          & daytime, heavy traffic                                                                            & yes                                     & 195                                                                                            & \begin{tabular}[c]{@{}l@{}}MOG2 overreaction \\ detection: higher \\ sensitivity\end{tabular} \\ \hline
\end{tabular}
\end{adjustbox}
\caption{My caption}
\label{my-label}
\end{table}

\subsection{Results}
\subsubsection{Initial setting}
- minSize: 250
- lanes: defined for most videos

\subsubsection{The minimal size of blobs redefined}
- minSize: 200
- lanes: defined for most videos

\subsubsection{No lanes defined}
- minSize: 200
- lanes: no lanes

\subsubsection{Split size added}
- minSize: 100
- splitMinSize : 200

\subsection{Common errors and solutions}
\subsubsection{False positives}
\subsubsection{False negatives}
\subsubsection{Misclassification errors}

%----------------------------------------------------------------------------
\section{Calibration correction}\label{chap:cal_corr}
%----------------------------------------------------------------------------
Due to perspective transform, vehicle sizes on frames decrease as moving away from the camera.
Since vehicle lengths are the basis of classification, perspective distortion must be eliminated.
For this purpose quadrangle-based compensation method is used in the Traffic Sensor.

The quadrangle, called the calibration rectangle, is manually defined by the user.
It is hand-drawn on a frame in the Project Configurator GUI (section \ref{chap:calibration}.) as part of the calibration process.
The position and the sides' lengths are estimated with the help of any occurring road lanes, or simply based on naked eye examination.
On this wise, due to the inaccuracy of human perception, the location and size of the calibration rectangle are significantly uncertain.
Empirical analysis shows that errors are actually present in many hand-calibrated videos.

To avoid manual calibration, some traffic surveillance systems automatize this process.
However in heterogeneous environment, it is a highly complex problem, and is not implemented in the current version of the Traffic Sensor system.

However, the existing settings can be corrected.
To evaluate the degree of miscalibration, lengths of the vehicles are examined as a function of distance from the camera.
After, during the finishing steps of the processing, the calibration rectangle is redefined for later use.
To eliminate false detections of miscalibration, the proposed corrections are revised by the user or the developer.

\subsection{The miscalibration problem}
\subsubsection{Perspective compensation method}
The calibration rectangle is constructed by defining its four edges from the upper left corner, to the lower left one in order.
The edges must be coplanar in the plane of the street, and correspond to those of a square's in the 3-dimensional (3D) world.
The square, due to the perspective transformation, shows as a general rectangle on the image plane.
On most videos, lane markings are used to find and define the square, since they are parallel lines in the road.
The length of the rectangle's sides are also approximated and set by the user.

The four vertices are then projected back into a square, along with the entire pixel grid of the image using a transformation map to speed up the process.
Examples of the Frames, before and after the perspective compensation transformation, are seen in figure \ref{fig:perscomp}.
For defining the transform and constructing the map, universal OpenCV methods were used\cite{PersTrans, WrapPers}.

\begin{figure}[!t]
	\centering
		\begin{subfigure}[b]{0.4\textwidth}
			\includegraphics[width=\textwidth]{raw_frame_ibike.png}
			\caption{A Raw Frame from the ErE5 video sequence.}
		\end{subfigure}
		\quad
		\begin{subfigure}[b]{0.4\textwidth}
			\includegraphics[width=\textwidth]{original_frame_ibike.png}
			\caption{An Original Frame from the ErE5 video sequence.}
		\end{subfigure}
		\hfill
		\begin{subfigure}[b]{0.4\textwidth}
			\includegraphics[width=\textwidth]{raw_frame_fovam.png}
			\caption{A Raw Frame from the FovamC\_D video sequence.}
		\end{subfigure}
		\quad
		\begin{subfigure}[b]{0.4\textwidth}
			\includegraphics[width=\textwidth]{original_frame_fovam.png}
			\caption{An Original Frame from the FovamC\_D video sequence.}
		\end{subfigure}
		
		\caption{Frames before and after the perspective compensation. The calibration rectangle's edges are marked with their sequential numbers.\label{fig:perscomp}}
\end{figure}

In the result images -- the Original Frame-strip -- the vehicle lengths are independent of the vehicle's position in the image. 

The calibration rectangle's sides are also used to define a scaling factor between the 3D world and the image plane.
Using the scaling factor, all lengths are converted to a metric scale, thus correct classification is possible.

\subsubsection{Miscalibrated streams}
If the calibration rectangle's edges are significantly displaced from those of a perfect coplanar square in the 3D world, the ensuing miscalibration considerably influences the accuracy of the classification results.
To detect whether this problem occurs, vehicle lengths are analysed along the tripwire.

\begin{figure}[!t]
	\centering
	\begin{subfigure}[b]{\textwidth}
		\begin{subfigure}[t]{0.45\textwidth}
		\includegraphics[width=\textwidth]{FovamC_raw_frame_uncalib.png}
		\end{subfigure}
	\quad
		\begin{subfigure}[t]{0.375\textwidth}
		\includegraphics[width=\textwidth]{FovamC_uncalibrated_example.png}
		\end{subfigure}
	\subcaption{Uncalibrated.\label{sfig:uncalib}}
	\end{subfigure}
	\hfill
	\begin{subfigure}[b]{\textwidth}
		\begin{subfigure}[t]{0.45\textwidth}
			\includegraphics[width=\textwidth]{FovamC_mcalib.png}
		\end{subfigure}
		\quad
		\begin{subfigure}[t]{0.375\textwidth}
			\includegraphics[width=\textwidth]{FovamC_miscalib.png}
		\end{subfigure}
		\subcaption{Miscalibrated. \label{sfig:mcalib}}
	\end{subfigure}
	\hfill
	\begin{subfigure}[b]{\textwidth}
		\begin{subfigure}[t]{0.45\textwidth}
			\includegraphics[width=\textwidth]{FovamC_ccalib_frame.png}
		\end{subfigure}
		\quad
		\begin{subfigure}[t]{0.375\textwidth}
			\includegraphics[width=\textwidth]{FovamC_ccalib.png}
		\end{subfigure}
		\subcaption{Correctly calibrated.}
	\end{subfigure}

	\caption{Frame setting and average vehicle lengths along the Tripwire on the FovamC\_D video sequence, when the video is uncalibrated, miscalibrated and correctly calibrated. The tripwire is drawn with red. Some vehicle lengths are marked to show the difference in distance from the camera. On the correctly calibrated frame the lengths are approximately the same. The light blue line indicates the estimated slope of the length values.\label{fig:calibration_versions}}
\end{figure}

An uncalibrated stream is characterized by the decrease of vehicle lengths as moving away from the camera, due to perspective distortion, as seen on figure \ref{sfig:uncalib}.
If the lengths still decrease despite that perspective compensation was performed, there is a a high chance of inaccurate calibration (an example is seen in figure \ref{sfig:mcalib}.), meaning that perspective distortion was not compensated well.
Some exceptions may occur, e.g. when a walking route and a bicycle track runs next to the road, where the typical road users are of smaller size.

To accurately estimate the average size of road users along a line, a rather long video sequence needs to be analysed to count enough vehicles for averaging.
The video length was empirically approximated to be at least 6000-frame long.

\subsection{Solutions}
In the following section the method, proposed to correct the erroneous calibration, is presented.

The three stages of the correction process are as follows:
\begin{enumerate}
\item At the first step, a line is fitted to the vehicle length data using linear regression.
\item Next, the average lengths at the two sides of the calibration rectangle are calculated from the parameters of the approximated line.
\item Last, a the ratio of these sizes are used to reshape the sides of the calibration rectangle.
\end{enumerate}

The steps are detailed as follows:
\begin{enumerate}
	\item  \textbf{Line estimation:} 
	Calibration correction is performed in single-run mode, after the entire length of the video is processed.
	During the detection phase, in each point of the Tripwire, using the data of the Size Timeline, the average vehicle lengths are iteratively recalculated with the newly calculated size values.
	The result of the calculation can then be visualized (as presented in section \ref{sec:data_representation}) as a curve of vehicle sizes as a function of position on the Tripwire.
	For quantifying the degree of the decrease, a line is fitted to the data set with a simple least square approximation.
	The parameters of the line are stored.
	
	\item  \textbf{Size ratio calculation:}
	\item  \textbf{Rectangle correction}
\end{enumerate}
- quantify the decrease of the lengths
- based on the correct lengths, redraw the calibration rect

\subsection{Calibration correction results}
\ref{fig:calibrations2}

The results of miscalibration are presented using four test videos, that were initially miscalibrated.


\addtolength{\topmargin}{-.6in}
\begin{figure}[p]
	\thispagestyle{empty}
	\centering
	\thisfloatpagestyle{empty}
	\begin{subfigure}[t]{0.36\textwidth}
		\includegraphics[width=\textwidth]{calibrationCorrection_GoldA2_Not_OK.png}
		\caption{GoldA2, miscalibrated.}
	\end{subfigure}
	\quad
	\begin{subfigure}[t]{0.36\textwidth}
		\includegraphics[width=\textwidth]{calibrationCorrection_OK_GoldA2.png}
		\caption{GoldA2, corrected.}
	\end{subfigure}
	\hfill
	\begin{subfigure}[t]{0.36\textwidth}
		\includegraphics[width=\textwidth]{calibrationCorrection_Fovam_not_OK.png}
		\caption{FovamC\_D, miscalibrated.}
	\end{subfigure}
	\quad
	\begin{subfigure}[t]{0.36\textwidth}
		\includegraphics[width=\textwidth]{calibrationCorrection_Fovam_OK.png}
		\caption{FovamC\_D, corrected.}
	\end{subfigure}
\hfill
\begin{subfigure}[t]{0.36\textwidth}
	\includegraphics[width=\textwidth]{calibrationCorrection_OK_SasA1_Med.png}
	\caption{SasA1, miscalibrated.}
\end{subfigure}
\quad
\begin{subfigure}[t]{0.36\textwidth}
	\includegraphics[width=\textwidth]{calibrationCorrection_not_OK_SasA1_Med.png}
	\caption{SasA1, corrected.}
\end{subfigure}
\hfill
\begin{subfigure}[t]{0.36\textwidth}
	\includegraphics[width=\textwidth]{calibrationCorrection_not_OK_GoldB1_Sun.png}
	\caption{GoldB1, miscalibrated.}
\end{subfigure}
\quad
\begin{subfigure}[t]{0.36\textwidth}
	\includegraphics[width=\textwidth]{calibrationCorrection_OK_GoldB1_Sun.png}
	\caption{GoldB1, corrected.}
\end{subfigure}
	\caption{Average vehicle lengths along the Tripwire calculated from a the same Frame-strip before and after calibration correction. After the correction, average sizes are distributed uniformly along the Tripwire.(The light blue line indicates the estimated slope of the length values.)\label{fig:calibrations2}}
\end{figure}
%----------------------------------------------------------------------------
\section{Speed testing}
%----------------------------------------------------------------------------
- Speed criteria to meet:
	- minimum speed \SI{25}{frame/s}
	- loosing frames and thus vehicles
	- the optimum is higher, \SI{30}{frame/s}
	- important to be higher for the integration of new functions, processing steps, or extending existing ones
	- e.g. shadow-detection feature, or a more sophisticated classifier

\subsection{Results}
